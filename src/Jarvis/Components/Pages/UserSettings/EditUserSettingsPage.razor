@page "/settings"
@using Jarvis.Clients
@using Jarvis.Components.Pages.Shared
@using Jarvis.Models.User
@using Microsoft.FluentUI.AspNetCore.Components.Extensions

@inject IJarvisApiClient _apiClient
@inject NavigationManager _navManager
@inject IToastService _toastService

<ConfigurationHeader Title="Configurações" />

@if (_update is null)
{
    <FluentProgress></FluentProgress>
}
else
{
    <div class="d-flex gap-2">
        <FluentButton>Geral</FluentButton>
        <FluentButton>Integrações</FluentButton>
    </div>
    <div class="d-flex flex-column justify-content-center align-items-center">
        <img class="rounded-circle mb-2" src="@(CascadingUser.User.ProfilePictureUrl)" height="75" width="75" />
        <InputFile class="form-control w-50" OnChange=UploadNewProfilePhoto>Editar foto</InputFile>
    </div>

    <FluentEditForm Model=_update OnValidSubmit=EditAsync>
        <FluentTextField @bind-Value=_update.Name Label="Nome" />
        <FluentTextField @bind-Value=_update.LastName Label="Sobrenome" />
        <FluentLabel>Tags</FluentLabel>
        <FluentButton OnClick=RedirectToTags>Gerenciar tags</FluentButton>
        <FluentNumberField Label="Meta diária" @bind-Value=_update.WinTheDayGoal />        
    </FluentEditForm>
}


@code {
    [CascadingParameter, EditorRequired]
    private CascadingUser CascadingUser { get; set; } = default!;

    private UpdateUserModel? _update;

    private Stream? _profilePicture;
    private string? _profilePictureName;

    protected override void OnInitialized()
    {
        if (CascadingUser?.User is null)
            return;

        var user = CascadingUser.User;

        _update = new()
        {
            WinTheDayGoal = user.WinTheDayGoal ?? 0,
            Name = user.Name,
            LastName = user.LastName,
        };
    }

    private void RedirectToTags()
    {
        _navManager.NavigateTo("/tags");
    }

    private void UploadNewProfilePhoto(InputFileChangeEventArgs args)
    {
        if (_update is null)
            return;

        _profilePicture = args.File.OpenReadStream();
        _profilePictureName = args.File.Name;
    }

    private async Task EditAsync()
    {
        if (CascadingUser?.User is null || _update is null)
            return;

        if (_profilePicture is null || string.IsNullOrEmpty(_profilePictureName))
        {
            _toastService.ShowWarning("Envie uma foto de perfil para prosseguir");
            return;
        }

        var user = await _apiClient.Users.UpdateAsync(_update, _profilePicture, _profilePictureName);

        CascadingUser.UpdateUser(user);

        _toastService.ShowSuccess("Usuário atualizado com sucesso!");
    }
}
