@using Jarvis.Const
@using Jarvis.Extensions
@using Jarvis.Models.User
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject NavigationManager _navManager


<CascadingValue Value=this>
    @ChildContent
</CascadingValue>

@code {
    [Parameter, EditorRequired]
    public RenderFragment? ChildContent { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    public UserModel? User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask is null)
            return;

        var auth = await AuthenticationStateTask;

        if (auth.User?.Identity is null || !auth.User.Identity.IsAuthenticated)
        {
            _navManager.NavigateTo("/login");
            return;
        }

        User = new UserModel
        {
            Email = auth.User.GetEmail(),
            Name = auth.User.GetName(),
            PictureUrl = auth.User.GetProfilePicture(),
            DailyMeta = auth.User.GetDailyMeta(),
            Password = string.Empty,
        };
    }
}
